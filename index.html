<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

</head>
<body>
File:<textarea id="file"></textarea>
<div>File Name:<input type="text" id="fileName"></div>
<button class="btn btn-default" id="create">Create File</button>
<div id="game" style="width:1200px;height:700px;border:solid black 1px;position:absolute;top:200px;left:0;">
</div>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
<script>
    var socket = io();
    $('#file').keyup((e)=>{
        socket.emit('text',e.target.value);
    });
    socket.on('read',(txt)=>{
        $('#file').val(txt);
    });
    $('#create').click(()=>{

        });
    socket.on('die',({e1,e2})=>{console.log(e1.top,e2.top)});
    const id=Math.round(Math.random()*10000)+1;
    let me={
        template:`<div id="${id}" style="width:15px;height:15px;border:solid aquamarine 1px;background-color: aquamarine;position:absolute;top:0;left:0;"></div>`,
        position:{top:0,left:0},
        bombs:[],
        id:id,
        move(d,step){

                if (d === 'up' && this.position.top>0 ) {
                    this.position.top = this.position.top - step;
                }
                if (d === 'down'&& this.position.top<=675 ) {
                    this.position.top = this.position.top + step;
                }
                if (d === 'right'&& this.position.left<=1175) {
                    this.position.left = this.position.left + step;
                }
                if (d === 'left' && this.position.left>0) {
                    this.position.left = this.position.left - step;
                }
                console.log('#'+id);
                $(`#${id}`).css('top', this.position.top).css('left', this.position.left);
                socket.emit('move',this);
        },
       init(){
            $('#game').append(this.template);
       },
       bomb(){
           const bombId=Math.round(Math.random()*10000)+10000;
           $('#game').append(`<div id="${bombId}" style="width:15px;height:15px;border:solid black 1px;background-color: black;position:absolute;
             top:${this.position.top}px;left:${this.position.left}px;"></div>`);
           this.bombs.push({top:this.position.top,left:this.position.left,level:2});
           this.setting(2000,bombId).then(this.explode);

       },
        setting(time,bombId){
        return new Promise((resolve, reject)=>{
            setTimeout(()=>resolve(bombId),time);
        });
    },
        explode(bombId){
            return new Promise(()=>{
                const eId1=Math.round(Math.random()*10000)+20000,
                 etop1=$(`#${bombId}`).css('top'),
                 eleft1=parseInt($(`#${bombId}`).css('left'))-30+'px',
                 eId2=Math.round(Math.random()*10000)+20000,
                 etop2=parseInt($(`#${bombId}`).css('top'))-30+'px',
                 eleft2=$(`#${bombId}`).css('left');
                $('#game').append(`<div id="${eId1}" style="position: absolute;top:${etop1};left:${eleft1};width:75px;height:15px;background-color: cadetblue;"></div>`);
                $('#game').append(`<div id="${eId2}" style="position: absolute;top:${etop2};left:${eleft2};width:15px;height:75px;background-color: cadetblue;"></div>`);
                socket.emit('explode',{e1:{top:etop1,left:eleft1},e2:{top:etop2,left:eleft2}});

                setTimeout(()=>{
                    console.log('remove');
                    $(`#${eId1}`).remove();
                    $(`#${eId2}`).remove();
                    $(`#${bombId}`).remove();
                },500);
            });
        }


    };
    me.init();
     $('body').on('keydown',(e)=>{
           const code= event.which || event.keyCode;
         if( code ===37){me.move('left',15);}
         if( code ===38){me.move('up',15);}
         if( code ===39){me.move('right',15);}
         if( code ===40){me.move('down',15);}
         if(code===32){ me.bomb();}
         return false;
     });
    socket.emit('login',me);
    socket.on('newuser',(e)=>{
        const newId=Math.round(Math.random()*10000)+1;
       $('#game').append(`<div id="${newId}" style="width:15px;height:15px;border:solid aquamarine 1px;background-color: aquamarine;position:absolute;top:0;left:0;"></div>`);
    });
</script>

</body>
</html>